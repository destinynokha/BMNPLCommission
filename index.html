/**
 * Updated Honda Commission System - Apps Script
 * Handles form submissions (bypasses CORS issues)
 */

function doPost(e) {
  try {
    // SECURITY: Only allow INSERT operations - no updates or deletes
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Main_Data');
    
    // Get data from form parameters
    const data = e.parameter;
    
    // SECURITY CHECK: Validate required fields
    if (!data.vehicleName || !data.customerName || !data.salePrice || !data.salesPerson || !data.specialCommissionStaff) {
      throw new Error('Missing required fields');
    }
    
    // SECURITY CHECK: Validate data types
    if (isNaN(parseFloat(data.salePrice)) || parseFloat(data.salePrice) <= 0) {
      throw new Error('Invalid sale price');
    }
    
    // Get the first empty row (start from row 2, after headers)
    const lastRow = sheet.getLastRow();
    const newRow = Math.max(lastRow + 1, 2); // Ensure we start from row 2 minimum
    
    // Prepare row data with input sanitization - Updated with new staff fields
    const rowData = [
      '', // Entry_ID (will be auto-generated by formula we'll add)
      new Date().toISOString(), // Use server timestamp for security
      String(data.vehicleName || '').trim().substring(0, 50),
      String(data.model || '').trim().substring(0, 50),
      String(data.variant || '').trim().substring(0, 50),
      String(data.customerName || '').trim().substring(0, 100),
      String(data.salesPerson || '').trim().substring(0, 100), // Sales Person
      data.saleDate || '',
      Math.max(0, parseFloat(data.salePrice) || 0), // Ensure positive number
      data.isFinanced === 'true', // Convert string to boolean
      String(data.financingCompany || '').trim().substring(0, 100),
      String(data.financeStaff || '').trim().substring(0, 100), // Finance Staff
      Math.max(0, parseFloat(data.doAmount) || 0), // Ensure positive number
      data.doCommissionPayable === 'true', // Convert string to boolean
      String(data.specialCommissionStaff || '').trim().substring(0, 100), // Special Commission Staff
      String(data.remarks || '').trim().substring(0, 500) // Limit remarks length
    ];
    
    // INSERT data in the new row
    sheet.getRange(newRow, 1, 1, rowData.length).setValues([rowData]);
    
    // Add Entry_ID formula in column A for this specific row
    const entryIdFormula = `=IF(B${newRow}<>"", "SE" & TEXT(ROW()-1, "0000"), "")`;
    sheet.getRange(newRow, 1).setFormula(entryIdFormula);
    
    // Copy formulas down in Commission_Details sheet
    const commissionSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Commission_Details');
    const lastCommissionRow = Math.max(commissionSheet.getLastRow(), 1);
    const newCommissionRow = lastCommissionRow + 1;
    
    if (lastCommissionRow >= 2) {
      // Copy formulas from row 2
      commissionSheet.getRange(2, 1, 1, 12).copyTo(commissionSheet.getRange(newCommissionRow, 1, 1, 12));
    } else {
      // Add formulas for the first time - Updated with staff tracking
      const commissionFormulas = [
        `=Main_Data!A${newRow}`, // Entry_ID
        `=Main_Data!F${newRow}`, // Customer_Name
        `=Main_Data!C${newRow}&" "&Main_Data!D${newRow}&" "&Main_Data!E${newRow}`, // Vehicle_Info
        `=Main_Data!H${newRow}`, // Sale_Date
        `=Main_Data!I${newRow}`, // Sale_Price
        `=Main_Data!G${newRow}`, // Sales_Person
        `=IF(Main_Data!A${newRow}<>"", IFERROR(INDEX(Commission_Rates!$D:$D, MATCH(Main_Data!C${newRow}&Main_Data!D${newRow}&Main_Data!E${newRow}, Commission_Rates!$A:$A&Commission_Rates!$B:$B&Commission_Rates!$C:$C, 0)), 0), 0)`, // Sales_Commission
        `=Main_Data!L${newRow}`, // Finance_Staff
        `=IF(AND(Main_Data!N${newRow}=TRUE, Main_Data!M${newRow}>=Main_Data!I${newRow}+2000), 1000, 0)`, // Finance_Commission
        `=Main_Data!O${newRow}`, // Special_Commission_Staff
        `=IF(Main_Data!A${newRow}<>"", 300, 0)`, // Special_Commission
        `=G${newCommissionRow}+I${newCommissionRow}+K${newCommissionRow}` // Total_Commission
      ];
      
      for (let i = 0; i < commissionFormulas.length; i++) {
        commissionSheet.getRange(newCommissionRow, i + 1).setFormula(commissionFormulas[i]);
      }
    }
    
    // Copy formulas down in All_Entries sheet (if exists)
    const allEntriesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('All_Entries');
    if (allEntriesSheet) {
      const lastEntriesRow = Math.max(allEntriesSheet.getLastRow(), 1);
      const newEntriesRow = lastEntriesRow + 1;
      
      if (lastEntriesRow >= 2) {
        // Copy formulas from row 2
        allEntriesSheet.getRange(2, 1, 1, 16).copyTo(allEntriesSheet.getRange(newEntriesRow, 1, 1, 16));
      } else {
        // Add formulas for the first time - Updated with staff fields
        const entriesFormulas = [
          `=Main_Data!A${newRow}`, // Entry_ID
          `=IF(Main_Data!B${newRow}<>"", TEXT(Main_Data!B${newRow}, "DD/MM/YYYY HH:MM"), "")`, // Formatted Timestamp
          `=IF(Main_Data!H${newRow}<>"", TEXT(Main_Data!H${newRow}, "DD/MM/YYYY"), "")`, // Formatted Sale Date
          `=Main_Data!F${newRow}`, // Customer_Name
          `=Main_Data!C${newRow}`, // Vehicle_Name
          `=Main_Data!D${newRow}`, // Model
          `=Main_Data!E${newRow}`, // Variant
          `=Main_Data!I${newRow}`, // Sale_Price
          `=Main_Data!G${newRow}`, // Sales_Person
          `=IF(Main_Data!J${newRow}=TRUE, "Yes", IF(Main_Data!J${newRow}=FALSE, "No", ""))`, // Is_Financed
          `=Main_Data!K${newRow}`, // Financing_Company
          `=Main_Data!L${newRow}`, // Finance_Staff
          `=Main_Data!M${newRow}`, // DO_Amount
          `=IF(Main_Data!N${newRow}=TRUE, "Yes", IF(Main_Data!N${newRow}=FALSE, "No", ""))`, // DO_Commission_Payable
          `=Main_Data!O${newRow}`, // Special_Commission_Staff
          `=Main_Data!P${newRow}` // Remarks
        ];
        
        for (let i = 0; i < entriesFormulas.length; i++) {
          allEntriesSheet.getRange(newEntriesRow, i + 1).setFormula(entriesFormulas[i]);
        }
      }
    }
    
    // Log the insertion for audit trail
    console.log(`New entry inserted at row ${newRow}: ${data.customerName} - ${data.vehicleName} ${data.model} ${data.variant} - Sales: ${data.salesPerson}, Special: ${data.specialCommissionStaff}`);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true, 
        row: newRow, 
        message: 'Entry submitted successfully with staff tracking'
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // Log security violations
    console.error('Security violation or error:', error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false, 
        error: 'Operation failed: ' + error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  // Simple health check
  return ContentService.createTextOutput('Honda Commission System API - Running and Ready');
}

// SECURITY: Explicitly disable any other functions that might modify data
function onEdit() {
  // This function is disabled to prevent any modifications from the sheet itself
  return false;
}

function onFormSubmit() {
  // This function is disabled to prevent any modifications
  return false;
}

/**
 * Setup function (keep this for initial setup)
 */
function setupHondaCommissionSystem() {
  try {
    console.log('üöÄ Starting Honda Commission System setup...');
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // Step 1: Create all required sheets
    createAllSheets(ss);
    
    // Step 2: Setup Main_Data sheet
    setupMainDataSheet(ss);
    
    // Step 3: Setup Commission_Rates sheet
    setupCommissionRatesSheet(ss);
    
    // Step 4: Setup Master_Data sheet
    setupMasterDataSheet(ss);
    
    // Step 5: Setup Commission_Details sheet
    setupCommissionDetailsSheet(ss);
    
    // Step 6: Setup All_Entries sheet
    setupAllEntriesSheet(ss);
    
    // Step 7: Setup Dashboard sheet
    setupDashboardSheet(ss);
    
    // Step 8: Apply formatting
    applyFormatting(ss);
    
    console.log('‚úÖ Honda Commission System setup completed successfully!');
    
    // Show completion message
    SpreadsheetApp.getUi().alert(
      'Setup Complete!', 
      'Honda Commission System has been set up successfully!\n\n' +
      '‚úÖ All 6 sheets created\n' +
      '‚úÖ Headers and formulas added\n' +
      '‚úÖ Sample data populated\n' +
      '‚úÖ Formatting applied\n\n' +
      'You can now deploy the web app and start using the system!',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
  } catch (error) {
    console.error('‚ùå Setup failed:', error);
    SpreadsheetApp.getUi().alert('Setup Error', 'Setup failed: ' + error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function createAllSheets(ss) {
  console.log('üìã Creating sheets...');
  
  // Remove default sheet if it exists and is empty
  const defaultSheet = ss.getSheets()[0];
  if (defaultSheet.getName() === 'Sheet1' && defaultSheet.getLastRow() <= 1) {
    ss.deleteSheet(defaultSheet);
  }
  
  const sheetNames = ['Main_Data', 'Commission_Rates', 'Master_Data', 'Commission_Details', 'All_Entries', 'Dashboard'];
  
  sheetNames.forEach(name => {
    // Check if sheet already exists
    let sheet = ss.getSheetByName(name);
    if (!sheet) {
      sheet = ss.insertSheet(name);
      console.log(`‚úÖ Created sheet: ${name}`);
    } else {
      console.log(`üìã Sheet already exists: ${name}`);
    }
  });
}

function setupMainDataSheet(ss) {
  console.log('üóÇÔ∏è Setting up Main_Data sheet...');
  
  const sheet = ss.getSheetByName('Main_Data');
  
  // Headers
  const headers = [
    'Entry_ID', 'Timestamp', 'Vehicle_Name', 'Model', 'Variant', 
    'Customer_Name', 'Sale_Date', 'Sale_Price', 'Is_Financed', 
    'Financing_Company', 'DO_Amount', 'DO_Commission_Payable', 'Remarks'
  ];
  
  // Set headers
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // Add Entry_ID formula in A2 (will auto-copy down)
  sheet.getRange('A2').setFormula('=IF(B2<>"", "SE" & TEXT(ROW()-1, "0000"), "")');
  
  console.log('‚úÖ Main_Data sheet setup complete');
}

function setupCommissionRatesSheet(ss) {
  console.log('üí∞ Setting up Commission_Rates sheet...');
  
  const sheet = ss.getSheetByName('Commission_Rates');
  
  // Headers
  const headers = ['Vehicle_Name', 'Model', 'Variant', 'Sales_Commission'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // Sample commission data
  const sampleRates = [
    ['Activa', '6G', 'Standard', 500],
    ['Activa', '6G', 'Deluxe', 600],
    ['Activa', '125', 'Standard', 550],
    ['Activa', '125', 'Deluxe', 650],
    ['Dio', '110', 'Standard', 450],
    ['Dio', '110', 'Deluxe', 550],
    ['CB Shine', '125', 'Drum', 700],
    ['CB Shine', '125', 'Disc', 800],
    ['SP 125', '125', 'Drum', 750],
    ['SP 125', '125', 'Disc', 850],
    ['Unicorn', '150', 'Standard', 900],
    ['Unicorn', '160', 'Standard', 950],
    ['Hornet', '160', 'Standard', 1000],
    ['Hornet', '180', 'Standard', 1100],
    ['X-Blade', '160', 'Standard', 950],
    ['X-Blade', '160', 'ABS', 1050]
  ];
  
  sheet.getRange(2, 1, sampleRates.length, 4).setValues(sampleRates);
  
  console.log('‚úÖ Commission_Rates sheet setup complete');
}

function setupMasterDataSheet(ss) {
  console.log('üìù Setting up Master_Data sheet...');
  
  const sheet = ss.getSheetByName('Master_Data');
  
  // Vehicle Names (Column A)
  const vehicleNames = [
    ['Vehicle_Name'],
    ['Activa'],
    ['Dio'],
    ['CB Shine'],
    ['SP 125'],
    ['Unicorn'],
    ['Hornet'],
    ['X-Blade']
  ];
  sheet.getRange(1, 1, vehicleNames.length, 1).setValues(vehicleNames);
  
  // Models (Column C)
  const models = [
    ['Model'],
    ['6G'],
    ['110'],
    ['125'],
    ['150'],
    ['160'],
    ['180']
  ];
  sheet.getRange(1, 3, models.length, 1).setValues(models);
  
  // Variants (Column E)
  const variants = [
    ['Variant'],
    ['Standard'],
    ['Deluxe'],
    ['Drum'],
    ['Disc'],
    ['CBS'],
    ['ABS']
  ];
  sheet.getRange(1, 5, variants.length, 1).setValues(variants);
  
  // Financing Companies (Column G)
  const financingCompanies = [
    ['Financing_Company'],
    ['Bajaj Finserv'],
    ['Hero FinCorp'],
    ['HDFC Bank'],
    ['ICICI Bank'],
    ['Cholamandalam Finance'],
    ['Tata Capital'],
    ['Mahindra Finance']
  ];
  sheet.getRange(1, 7, financingCompanies.length, 1).setValues(financingCompanies);
  
  console.log('‚úÖ Master_Data sheet setup complete');
}

function setupCommissionDetailsSheet(ss) {
  console.log('üßÆ Setting up Commission_Details sheet...');
  
  const sheet = ss.getSheetByName('Commission_Details');
  
  // Headers
  const headers = [
    'Entry_ID', 'Customer_Name', 'Vehicle_Info', 'Sale_Date', 'Sale_Price',
    'Sales_Commission', 'Special_Commission', 'Finance_Commission', 'Total_Commission'
  ];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // Formulas for row 2
  const formulas = [
    '=Main_Data!A2',
    '=Main_Data!F2',
    '=Main_Data!C2&" "&Main_Data!D2&" "&Main_Data!E2',
    '=Main_Data!G2',
    '=Main_Data!H2',
    '=IF(Main_Data!A2<>"", IFERROR(INDEX(Commission_Rates!$D:$D, MATCH(Main_Data!C2&Main_Data!D2&Main_Data!E2, Commission_Rates!$A:$A&Commission_Rates!$B:$B&Commission_Rates!$C:$C, 0)), 0), 0)',
    '=IF(Main_Data!A2<>"", 300, 0)',
    '=IF(AND(Main_Data!L2=TRUE, Main_Data!K2>=Main_Data!H2+2000), 1000, 0)',
    '=F2+G2+H2'
  ];
  
  // Set formulas in row 2
  for (let i = 0; i < formulas.length; i++) {
    sheet.getRange(2, i + 1).setFormula(formulas[i]);
  }
  
  console.log('‚úÖ Commission_Details sheet setup complete');
}

function setupAllEntriesSheet(ss) {
  console.log('üìã Setting up All_Entries sheet...');
  
  const sheet = ss.getSheetByName('All_Entries');
  
  // Headers for display
  const headers = [
    'Entry ID', 'Date Submitted', 'Sale Date', 'Customer Name', 
    'Vehicle', 'Model', 'Variant', 'Sale Price', 'Financed?',
    'Financing Company', 'DO Amount', 'DO Commission?', 'Remarks'
  ];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // Formulas to pull data from Main_Data with better formatting
  const formulas = [
    '=Main_Data!A2',
    '=IF(Main_Data!B2<>"", TEXT(Main_Data!B2, "DD/MM/YYYY HH:MM"), "")',
    '=IF(Main_Data!G2<>"", TEXT(Main_Data!G2, "DD/MM/YYYY"), "")',
    '=Main_Data!F2',
    '=Main_Data!C2',
    '=Main_Data!D2',
    '=Main_Data!E2',
    '=Main_Data!H2',
    '=IF(Main_Data!I2=TRUE, "Yes", IF(Main_Data!I2=FALSE, "No", ""))',
    '=Main_Data!J2',
    '=Main_Data!K2',
    '=IF(Main_Data!L2=TRUE, "Yes", IF(Main_Data!L2=FALSE, "No", ""))',
    '=Main_Data!M2'
  ];
  
  // Set formulas in row 2
  for (let i = 0; i < formulas.length; i++) {
    sheet.getRange(2, i + 1).setFormula(formulas[i]);
  }
  
  console.log('‚úÖ All_Entries sheet setup complete');
}

function setupDashboardSheet(ss) {
  console.log('üìä Setting up Dashboard sheet...');
  
  const sheet = ss.getSheetByName('Dashboard');
  
  // Title
  sheet.getRange('A1').setValue('Honda Dealership - Sales Dashboard');
  
  // Key Metrics Section
  const metricsLabels = [
    ['Metric', 'Value'],
    ['Total Sales Today', '=COUNTIFS(Main_Data!G:G, TODAY())'],
    ['Total Sales This Month', '=COUNTIFS(Main_Data!G:G, ">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1), Main_Data!G:G, "<"&DATE(YEAR(TODAY()),MONTH(TODAY())+1,1))'],
    ['Total Revenue Today', '=SUMIFS(Main_Data!H:H, Main_Data!G:G, TODAY())'],
    ['Total Revenue This Month', '=SUMIFS(Main_Data!H:H, Main_Data!G:G, ">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1), Main_Data!G:G, "<"&DATE(YEAR(TODAY()),MONTH(TODAY())+1,1))'],
    ['Financed Sales %', '=IF(COUNTA(Main_Data!I:I)>1, COUNTIF(Main_Data!I:I, TRUE)/(COUNTA(Main_Data!I:I)-1)*100, 0)'],
    ['Avg Sale Price', '=IF(COUNTA(Main_Data!H:H)>1, AVERAGE(Main_Data!H2:H1000), 0)'],
    ['Total Sales Commission', '=SUM(Commission_Details!F:F)'],
    ['Total Special Commission', '=SUM(Commission_Details!G:G)'],
    ['Total Finance Commission', '=SUM(Commission_Details!H:H)'],
    ['Total All Commissions', '=SUM(Commission_Details!I:I)']
  ];
  
  sheet.getRange(3, 1, metricsLabels.length, 2).setValues(metricsLabels);
  
  console.log('‚úÖ Dashboard sheet setup complete');
}

function applyFormatting(ss) {
  console.log('üé® Applying formatting...');
  
  // Format Main_Data sheet
  const mainSheet = ss.getSheetByName('Main_Data');
  mainSheet.getRange(1, 1, 1, 13).setBackground('#d32f2f').setFontColor('#ffffff').setFontWeight('bold');
  mainSheet.getRange('H:H').setNumberFormat('‚Çπ#,##0'); // Sale Price
  mainSheet.getRange('K:K').setNumberFormat('‚Çπ#,##0'); // DO Amount
  
  // Format Commission_Rates sheet
  const ratesSheet = ss.getSheetByName('Commission_Rates');
  ratesSheet.getRange(1, 1, 1, 4).setBackground('#d32f2f').setFontColor('#ffffff').setFontWeight('bold');
  ratesSheet.getRange('D:D').setNumberFormat('‚Çπ#,##0'); // Commission amounts
  
  // Format Master_Data sheet
  const masterSheet = ss.getSheetByName('Master_Data');
  masterSheet.getRange('A1').setBackground('#d32f2f').setFontColor('#ffffff').setFontWeight('bold');
  masterSheet.getRange('C1').setBackground('#d32f2f').setFontColor('#ffffff').setFontWeight('bold');
  masterSheet.getRange('E1').setBackground('#d32f2f').setFontColor('#ffffff').setFontWeight('bold');
  masterSheet.getRange('G1').setBackground('#d32f2f').setFontColor('#ffffff').setFontWeight('bold');
  
  // Format Commission_Details sheet
  const detailsSheet = ss.getSheetByName('Commission_Details');
  detailsSheet.getRange(1, 1, 1, 9).setBackground('#d32f2f').setFontColor('#ffffff').setFontWeight('bold');
  detailsSheet.getRange('E:I').setNumberFormat('‚Çπ#,##0'); // All commission columns
  
  // Format All_Entries sheet
  const entriesSheet = ss.getSheetByName('All_Entries');
  entriesSheet.getRange(1, 1, 1, 13).setBackground('#d32f2f').setFontColor('#ffffff').setFontWeight('bold');
  entriesSheet.getRange('H:H').setNumberFormat('‚Çπ#,##0'); // Sale Price
  entriesSheet.getRange('K:K').setNumberFormat('‚Çπ#,##0'); // DO Amount
  entriesSheet.setFrozenRows(1); // Freeze header row
  
  // Add alternating row colors for better readability
  const entriesRange = entriesSheet.getRange('A2:M1000');
  entriesRange.applyRowBanding(SpreadsheetApp.BandingTheme.LIGHT_GREY, true, false);
  
  // Format Dashboard sheet
  const dashSheet = ss.getSheetByName('Dashboard');
  dashSheet.getRange('A1').setBackground('#d32f2f').setFontColor('#ffffff').setFontWeight('bold').setFontSize(16);
  dashSheet.getRange('A3:B3').setBackground('#f5f5f5').setFontWeight('bold');
  
  // Set currency format for dashboard
  dashSheet.getRange('B6:B7').setNumberFormat('‚Çπ#,##0'); // Revenue fields
  dashSheet.getRange('B8').setNumberFormat('0.00%'); // Percentage format for financed sales
  dashSheet.getRange('B9:B13').setNumberFormat('‚Çπ#,##0'); // Commission fields
  
  // Auto-resize columns
  const sheets = ['Main_Data', 'Commission_Rates', 'Master_Data', 'Commission_Details', 'All_Entries', 'Dashboard'];
  sheets.forEach(sheetName => {
    const sheet = ss.getSheetByName(sheetName);
    sheet.autoResizeColumns(1, sheet.getLastColumn());
  });
  
  console.log('‚úÖ Formatting applied successfully');
}
